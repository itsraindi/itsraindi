name: Simple Stats Card

on:
  schedule:
    - cron: "0 3 * * *" # daily 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Generate simple-stats.svg (no heredoc)
        uses: actions/github-script@v7
        env:
          USERNAME: itsraindi
          TITLE: "Amemaru's GitHub Stats"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const username = process.env.USERNAME || context.repo.owner;
            const title = process.env.TITLE || "GitHub Stats";

            const now = new Date();
            const to = now.toISOString();
            const from = new Date(now.getTime() - 365*24*60*60*1000).toISOString();

            const query = `
              query($login:String!, $from:DateTime!, $to:DateTime!, $after:String) {
                user(login:$login) {
                  pullRequests { totalCount }
                  issues { totalCount }
                  contributionsCollection(from:$from, to:$to) {
                    totalCommitContributions
                    totalRepositoryContributions
                  }
                  repositories(ownerAffiliations: OWNER, isFork:false, first:100, after:$after) {
                    nodes { stargazerCount }
                    pageInfo { hasNextPage endCursor }
                  }
                }
              }
            `;

            let after = null;
            let totalStars = 0;

            let prsTotal = 0;
            let issuesTotal = 0;
            let commitsLastYear = 0;
            let reposContribLastYear = 0;

            while (true) {
              const res = await github.graphql(query, { login: username, from, to, after });
              const u = res.user;

              prsTotal = u.pullRequests.totalCount;
              issuesTotal = u.issues.totalCount;

              commitsLastYear = u.contributionsCollection.totalCommitContributions;
              reposContribLastYear = u.contributionsCollection.totalRepositoryContributions;

              const repo = u.repositories;
              totalStars += repo.nodes.reduce((s, n) => s + (n.stargazerCount || 0), 0);

              if (!repo.pageInfo.hasNextPage) break;
              after = repo.pageInfo.endCursor;
            }

            const fmtK = (n) => {
              if (n >= 1_000_000) return (n/1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
              if (n >= 1_000) return (n/1_000).toFixed(1).replace(/\.0$/, "") + "k";
              return String(n);
            };

            // simple grade by commits last year
            const activity = commitsLastYear;
            const grade =
              activity >= 500 ? "A+" :
              activity >= 300 ? "A"  :
              activity >= 200 ? "B+" :
              activity >= 100 ? "B"  :
              activity >= 50  ? "C"  : "D";

            // SVG (white card, looks great on dark GitHub)
            const W = 760, H = 180, pad = 26;
            const cardBg = "#ffffff", border = "#e5e7eb", accent = "#2f80ed";
            const text = "#111827", sub = "#374151";

            const lines = [
              ["Total Stars Earned:", fmtK(totalStars)],
              ["Total Commits (last year):", fmtK(commitsLastYear)],
              ["Total PRs:", fmtK(prsTotal)],
              ["Total Issues:", fmtK(issuesTotal)],
              ["Contributed to (last year):", fmtK(reposContribLastYear)],
            ];

            const y0 = 78, dy = 24, valueX = 420;
            const cx = W - 120, cy = 95;

            let body = "";
            for (let i = 0; i < lines.length; i++) {
              const [k, v] = lines[i];
              const y = y0 + i*dy;
              body += `
                <circle cx="${pad+6}" cy="${y-5}" r="5" fill="${accent}" opacity="0.9"/>
                <text x="${pad+26}" y="${y}" font-family="Segoe UI, Arial" font-size="14" fill="${sub}">${k}</text>
                <text x="${valueX}" y="${y}" font-family="Segoe UI, Arial" font-size="14" font-weight="700" fill="${text}">${v}</text>
              `;
            }

            const svg = `
              <svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
                <defs>
                  <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="0" dy="2" stdDeviation="6" flood-color="#000000" flood-opacity="0.12"/>
                  </filter>
                </defs>
                <rect x="10" y="10" width="${W-20}" height="${H-20}" rx="16" fill="${cardBg}" stroke="${border}" filter="url(#shadow)"/>
                <text x="${pad}" y="44" font-family="Segoe UI, Arial" font-size="20" font-weight="700" fill="${accent}">${title}</text>

                ${body}

                <circle cx="${cx}" cy="${cy}" r="44" fill="none" stroke="${accent}" stroke-width="10" opacity="0.35"/>
                <circle cx="${cx}" cy="${cy}" r="44" fill="none" stroke="${accent}" stroke-width="10" stroke-dasharray="220 60" stroke-linecap="round"/>
                <text x="${cx}" y="${cy+8}" text-anchor="middle" font-family="Segoe UI, Arial" font-size="28" font-weight="800" fill="${text}">${grade}</text>
              </svg>
            `.trim() + "\n";

            fs.writeFileSync("simple-stats.svg", svg, "utf8");
            core.info("Wrote simple-stats.svg");

      - name: Show status
        run: |
          ls -la
          git status --porcelain

      - name: Commit & push
        uses: EndBug/add-and-commit@v9
        with:
          add: "simple-stats.svg"
          message: "chore: update simple stats card"
          default_author: github_actions
          push: true


