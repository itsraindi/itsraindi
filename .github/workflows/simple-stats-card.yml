name: Simple Stats Card
on:
  schedule:
    - cron: "0 3 * * *"   # UTC 03:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Generate simple-stats.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: itsraindi
          TITLE: "Amemaru's GitHub Stats"
        run: |
          python - <<'PY'
          import os, json, urllib.request
          from datetime import datetime, timedelta, timezone

          token = os.environ["GITHUB_TOKEN"]
          username = os.environ["USERNAME"].strip()
          title = os.environ.get("TITLE", "GitHub Stats")

          def gql(query, variables):
            data = json.dumps({"query": query, "variables": variables}).encode("utf-8")
            req = urllib.request.Request(
              "https://api.github.com/graphql",
              data=data,
              headers={
                "Authorization": f"bearer {token}",
                "Content-Type": "application/json",
                "User-Agent": "simple-stats-card"
              }
            )
            with urllib.request.urlopen(req) as r:
              return json.loads(r.read().decode("utf-8"))

          now = datetime.now(timezone.utc)
          frm = (now - timedelta(days=365)).isoformat()
          to  = now.isoformat()

          query = """
          query($login:String!, $from:DateTime!, $to:DateTime!, $after:String) {
            user(login:$login) {
              pullRequests { totalCount }
              issues { totalCount }
              contributionsCollection(from:$from, to:$to) {
                totalCommitContributions
                totalRepositoryContributions
              }
              repositories(ownerAffiliations: OWNER, isFork:false, first:100, after:$after) {
                nodes { stargazerCount }
                pageInfo { hasNextPage endCursor }
              }
            }
          }
          """

          total_stars = 0
          after = None
          prs_total = issues_total = commits_last_year = repos_contrib_last_year = 0

          while True:
            res = gql(query, {"login": username, "from": frm, "to": to, "after": after})
            if "errors" in res:
              raise SystemExit("GraphQL error: " + json.dumps(res["errors"], indent=2))

            u = res["data"]["user"]
            prs_total = u["pullRequests"]["totalCount"]
            issues_total = u["issues"]["totalCount"]
            cc = u["contributionsCollection"]
            commits_last_year = cc["totalCommitContributions"]
            repos_contrib_last_year = cc["totalRepositoryContributions"]

            repo = u["repositories"]
            total_stars += sum(n["stargazerCount"] for n in repo["nodes"])
            if not repo["pageInfo"]["hasNextPage"]:
              break
            after = repo["pageInfo"]["endCursor"]

          def fmt_k(n):
            if n >= 1000000: return f"{n/1000000:.1f}M".replace(".0","")
            if n >= 1000: return f"{n/1000:.1f}k".replace(".0","")
            return str(n)

          activity = commits_last_year
          grade = "A+" if activity >= 500 else "A" if activity >= 300 else "B+" if activity >= 200 else "B" if activity >= 100 else "C"

          W, H = 760, 180
          pad = 26
          accent = "#2f80ed"
          border = "#e5e7eb"
          text  = "#111827"
          sub   = "#374151"

          lines = [
            ("Total Stars Earned:", fmt_k(total_stars)),
            ("Total Commits (last year):", fmt_k(commits_last_year)),
            ("Total PRs:", fmt_k(prs_total)),
            ("Total Issues:", fmt_k(issues_total)),
            ("Contributed to (last year):", fmt_k(repos_contrib_last_year)),
          ]

          y0, dy = 78, 24
          svg = [f'''<svg xmlns="http://www.w3.org/2000/svg" width="{W}" height="{H}" viewBox="0 0 {W} {H}">
          <rect x="10" y="10" width="{W-20}" height="{H-20}" rx="16" fill="#ffffff" stroke="{border}"/>
          <text x="{pad}" y="44" font-family="Segoe UI, Arial" font-size="20" font-weight="700" fill="{accent}">{title}</text>
          ''']

          for i,(k,v) in enumerate(lines):
            y = y0 + i*dy
            svg.append(f'<circle cx="{pad+6}" cy="{y-5}" r="5" fill="{accent}" opacity="0.9"/>')
            svg.append(f'<text x="{pad+26}" y="{y}" font-family="Segoe UI, Arial" font-size="14" fill="{sub}">{k}</text>')
            svg.append(f'<text x="420" y="{y}" font-family="Segoe UI, Arial" font-size="14" font-weight="700" fill="{text}">{v}</text>')

          cx, cy = W-120, 95
          svg.append(f'<circle cx="{cx}" cy="{cy}" r="44" fill="none" stroke="{accent}" stroke-width="10" opacity="0.35"/>')
          svg.append(f'<circle cx="{cx}" cy="{cy}" r="44" fill="none" stroke="{accent}" stroke-width="10" stroke-dasharray="220 60" stroke-linecap="round"/>')
          svg.append(f'<text x="{cx}" y="{cy+8}" text-anchor="middle" font-family="Segoe UI, Arial" font-size="28" font-weight="800" fill="{text}">{grade}</text>')
          svg.append('</svg>')

          with open("simple-stats.svg", "w", encoding="utf-8") as f:
            f.write("\n".join(svg))

          print("Wrote simple-stats.svg")
          PY

          ls -la
          test -f simple-stats.svg

      - name: Commit & push
        uses: EndBug/add-and-commit@v9
        with:
          add: "simple-stats.svg"
          message: "chore: update simple stats card"
          default_author: github_actions
          push: true

