name: Simple Stats Card

on:
  schedule:
    - cron: "0 3 * * *" # daily 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Generate simple-stats.svg (big student card, no border)
        uses: actions/github-script@v7
        env:
          USERNAME: itsraindi
          TITLE: "Amemaru's GitHub Stats"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");

            const username = process.env.USERNAME || context.repo.owner;
            const title = process.env.TITLE || "GitHub Stats";

            const now = new Date();
            const to = now.toISOString();
            const from = new Date(now.getTime() - 365*24*60*60*1000).toISOString();

            const query = `
              query($login:String!, $from:DateTime!, $to:DateTime!, $after:String) {
                user(login:$login) {
                  pullRequests { totalCount }
                  issues { totalCount }
                  contributionsCollection(from:$from, to:$to) {
                    totalCommitContributions
                    totalRepositoryContributions
                  }
                  repositories(ownerAffiliations: OWNER, isFork:false, first:100, after:$after) {
                    nodes { stargazerCount }
                    pageInfo { hasNextPage endCursor }
                  }
                }
              }
            `;

            let after = null;
            let totalStars = 0;
            let prsTotal = 0;
            let issuesTotal = 0;
            let commitsLastYear = 0;
            let reposContribLastYear = 0;

            while (true) {
              const res = await github.graphql(query, { login: username, from, to, after });
              const u = res.user;

              prsTotal = u.pullRequests.totalCount;
              issuesTotal = u.issues.totalCount;
              commitsLastYear = u.contributionsCollection.totalCommitContributions;
              reposContribLastYear = u.contributionsCollection.totalRepositoryContributions;

              const repo = u.repositories;
              totalStars += repo.nodes.reduce((s, n) => s + (n.stargazerCount || 0), 0);

              if (!repo.pageInfo.hasNextPage) break;
              after = repo.pageInfo.endCursor;
            }

            const fmtK = (n) => {
              if (n >= 1_000_000) return (n/1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
              if (n >= 1_000) return (n/1_000).toFixed(1).replace(/\.0$/, "") + "k";
              return String(n);
            };

            // Student thresholds (lower)
            const activity = commitsLastYear;
            const grade =
              activity >= 60 ? "A+" :
              activity >= 30 ? "A"  :
              activity >= 15 ? "B+" :
              activity >= 8  ? "B"  :
              activity >= 3  ? "C"  : "D";

            // Bigger, fuller "small card" (no border)
            const W = 540, H = 230, pad = 28;
            const cardBg = "#ffffff";
            const accent = "#2f80ed";
            const text = "#111827";
            const sub  = "#374151";

            const lines = [
              ["Total Stars Earned:", fmtK(totalStars)],
              ["Total Commits (last year):", fmtK(commitsLastYear)],
              ["Total PRs:", fmtK(prsTotal)],
              ["Total Issues:", fmtK(issuesTotal)],
              ["Contributed to (last year):", fmtK(reposContribLastYear)],
            ];

            const titleY = 54;
            const y0 = 96, dy = 30;
            const valueX = 360;

            // Grade circle on right
            const cx = W - 95, cy = 135;

            let rows = "";
            for (let i = 0; i < lines.length; i++) {
              const [k, v] = lines[i];
              const y = y0 + i * dy;
              rows += `
                <circle cx="${pad+6}" cy="${y-6}" r="5" fill="${accent}" opacity="0.9"/>
                <text x="${pad+26}" y="${y}" font-family="Segoe UI, Arial" font-size="16" fill="${sub}">${k}</text>
                <text x="${valueX}" y="${y}" font-family="Segoe UI, Arial" font-size="16" font-weight="800" fill="${text}">${v}</text>
              `;
            }

            const svg = `
              <svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
                <rect x="0" y="0" width="${W}" height="${H}" rx="18" fill="${cardBg}"/>
                <text x="${pad}" y="${titleY}" font-family="Segoe UI, Arial" font-size="22" font-weight="800" fill="${accent}">${title}</text>

                ${rows}

                <circle cx="${cx}" cy="${cy}" r="52" fill="none" stroke="${accent}" stroke-width="10" opacity="0.25"/>
                <circle cx="${cx}" cy="${cy}" r="52" fill="none" stroke="${accent}" stroke-width="10" stroke-dasharray="260 70" stroke-linecap="round"/>
                <text x="${cx}" y="${cy+10}" text-anchor="middle" font-family="Segoe UI, Arial" font-size="30" font-weight="900" fill="${text}">${grade}</text>
              </svg>
            `.trim() + "\n";

            fs.writeFileSync("simple-stats.svg", svg, "utf8");
            core.info("Wrote simple-stats.svg");

      - name: Commit & push
        uses: EndBug/add-and-commit@v9
        with:
          add: "simple-stats.svg"
          message: "chore: update simple stats card"
          default_author: github_actions
          push: true
